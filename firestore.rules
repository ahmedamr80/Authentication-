rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // --- HELPER FUNCTIONS ---
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isAdmin() {
      // Check if user has 'admin' custom claim OR 'admin' role in 'users' collection
      // SAFELY access the role field using .get() to prevent errors if field is missing
      return isSignedIn() && 
        ((request.auth.token.keys().hasAny(['admin']) && request.auth.token.admin == true) || 
         (exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.get('role', '') == 'admin'));
    }

    function isOwner(uid) {
      return isSignedIn() && request.auth.uid == uid;
    }
    
    // --- USERS ---
    match /users/{uid} {
      // 1. Reading: Open to all authenticated users (Community Feature)
      allow read: if isSignedIn();
      
      // 2. Creation: You can create your own, or an admin can create for you
      // RESTRICTION: Regular users cannot set 'role', 'isAdmin', or 'isShadow' on creation
      // We check if the NEW data contains any of these forbidden keys
      allow create: if isAdmin() || (
        isOwner(uid) && 
        !request.resource.data.keys().hasAny(['role', 'isAdmin', 'isShadow'])
      );
      
      // 3. Updating: 
      // - Must be Owner OR Admin
      // - AND: If you are the Owner (not Admin), you CANNOT change the 'role' or 'isAdmin' fields.
      allow update: if isAdmin() || (
        isOwner(uid) && 
        // Ensure the 'role' field is NOT being changed
        (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'isAdmin', 'isShadow']))
      );
                        
      // 4. Deletion: Admin only, or special "Claim Shadow" logic
      allow delete: if isAdmin() || (resource.data.isShadow == true && resource.data.email == request.auth.token.email);
    }
    
    // --- EVENTS ---
    match /events/{eventId} {
      // 1. Read: Publicly readable (good for sharing links)
      allow read: if true;
      
      // 2. Write: STRICTLY Admin only, with EXCEPTIONS for Client-Side Counters
      allow create, delete: if isAdmin();
      allow update: if isAdmin() || (
        isSignedIn() && 
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['registrationsCount', 'waitlistCount'])
      );
    }
    
    // --- REGISTRATIONS ---
    match /registrations/{registrationId} {
      allow read: if isSignedIn();
      
      // Allow create if self OR if creating for a team (presence of teamId in new data)
      allow create: if isSignedIn() && (request.resource.data.playerId == request.auth.uid || request.resource.data.teamId != null || isAdmin());
      
      // Allow update if self (P1 OR P2) OR if updating for a team
      allow update: if isSignedIn() && (
        resource.data.playerId == request.auth.uid || 
        resource.data.player2Id == request.auth.uid || 
        isAdmin()
      );
      
      allow delete: if isSignedIn() && (
        resource.data.playerId == request.auth.uid || 
        resource.data.player2Id == request.auth.uid || 
        isAdmin()
      );
    }
    
    // --- TEAMS ---
    match /teams/{teamId} {
      allow read: if isSignedIn();
      // Tighten write access: Only the creator (player1) can create a team where they are the leader
      allow create: if isSignedIn() && request.resource.data.player1Id == request.auth.uid;
      
      // Allow update/delete if you are a member of the team
      allow update, delete: if isSignedIn() && (
        resource.data.player1Id == request.auth.uid || 
        resource.data.player2Id == request.auth.uid ||
        isAdmin()
      );
    }
    
    // --- CLUBS ---
    match /clubs/{clubId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // --- MEDIA LIBRARY ---
    match /media_library/{mediaId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // --- NOTIFICATIONS ---
    match /notifications/{notificationId} {
      allow read, update, delete: if isSignedIn() && (resource.data.userId == request.auth.uid || isAdmin());
      allow create: if isSignedIn();
    }
    // --- COUNTERS ---
    match /counters/{counterId} {
      allow read, update, create: if isSignedIn();
    }
  }
}
